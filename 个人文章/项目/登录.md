# 技术
## 验证码
- 导入jar包
- 编写Kaptcha配置类
对外方法
- 生成随机字符         String text = kaptchaProducer.createText();

- 生成输入字符的图片   BufferedImage image = kaptchaProducer.createImage(text);

## 会话管理
### 项目如何保存的登录状态？
- 验证登录状态
    - 登录时，服务器会把logintikect保存在cookies中返回给客户端
    - 使用interceptor拦截客户端所有请求，判断发过来的cookies里面有没有ticket，如果有，且未过期并有效，保存登录状态。
- 使用拦截器处理所有请求，实现登录状态保存。
    - 进入Controller前
        - 使用ThreadLocal保存User对象作为登录状态。(可以通过User对象访问到用户的各项信息)
    - Controller解析处理器返回视图前
        - 将登录用户LoginUser 解析到所有请求最终返回的页面。
    - 视图解析结束，请求结束前
        - 每次请求结束时，将线程池清空，也就是删除用户登录状态。

# 项目

## 设计思路(怎么实现的)

用户登录成功后，要保存用户状态，就添加了登录凭证数据库表，登录时，对比登录凭证，如何登录成功，保存用户状态在ThreadLocal中，比如(购物车之类的)，以便后面的连接中使用。
因为要记录浏览器访问状态，所以选择使用cookies保存服务器发给的ticket随机字符串，在之后每次访问制定的目录时，都携带该cookie，从而实现有状态的访问

## 功能
- 验证码，异步请求方式
- 登录验证
- 生成登录凭证，发送给客户端

三次请求

## 实体类
创建LoginTicket实体类，与数据库字段对应


## 跳转登录页面     /login   Get
### 
简单的处理请求页面转发

## 登录页面登录     /login Post 参数需要携带用户名、密码、验证码、记住我、session，response、kaptchaOwner
验证账号  密码  验证码
成功后   生成  登录凭证，发送给客户端

### C
- 接受参数
- 验证验证码正确性
- 调用Service层的登陆方法，接受返回的消息(map)
- 根据成功或者失败渲染到不同界面
    - 失败到登录
    - 成功到首页

### S
- 验证
    - 验证用户、密码、验证码是否为未输入
    - 验证用户是否存在
    - 判断账号是否激活
    - 验证密码是否是与数据库一致
- 登录
    - 成功后生成并返回登录凭证(创建LoginTicket对象，返回ticket)(因为记住密码，所以要设置过期时间)
- 返回Controller层消息
    - 将上述的成功或者失败的消息封装到map中返回

### D
创建LoginTicket对应的crud 
- 更新ticket是否过期方法
- 增加ticket方法
- 根据ticket查询整个ticket记录方法。


## 验证码生成       /kaptcha Get   异步请求方式


## 逻辑（异步请求方式）
### 功能
通过AJAX异步请求方式，用户点击刷新验证码就会发出get请求，请求会返回一个新的验证码。

### Controller逻辑
需要给浏览器返回验证码
服务器需要保存验证码，在浏览器携带验证码发起登陆请求时，进行验证，由于这是隐私信息，而且跨请求，所以放在session中。

### 优化(放在redis中)

- 使用set数据结构存储
- 生成随机数生成key
- 给客户端添加这个随机数位value的cookies
- 使用这个key将验证码数字形式保存在redis内存中
    - 客户端每次登录时，服务器就可以比对它的cookies中的这个随机数，得到redis中存储的验证码，与用户输入的验证码进行比对。





