# 索引
## 解决的问题  查记录效率低
### 单页查找
```sql
select * from user where id = 1
```
对于这条查询语句，由于是主键作为筛选条件，所以，可以利用页目录，使用二分法查找页目录。然后在单个槽中查找该槽中的主键。

``` sql
select * from user where name = "王五"
```
对于这条sql语句，没有针对name属性的页目录，只能挨个遍历。

### 多页查找
当一个表中的数据被放在多个页里面时，要查找数据，只能挨个遍历所有的数据页，以及数据页里的记录。

而且多个数据页并不一定时挨着的，数据页是通过双向链表链接起来的，磁盘io花费时间更多，遍历花费时间更长。

## 解决查找问题  建立索引(类似页目录)

### 一句话总结
将所有的页按照主键大小，从小到大排序。
数据页有序了，就可以建立目录。
查找记录时，通过索引（目录）二分查找数据页，查询到具体的页，再通过槽二分查找记录。

### 排序
前一个数据页的主键值必须小于下一数据页的主键值（有序）

### 建立目录

使用InnoDB数据页结构来构建索引，普通的数据页存放的就是用户放入的普通记录，而构建索引的数据页存放的记录是目录项记录，他的record_type为1，标识该记录是索引，而不是普通记录。一个目录项记录只存放两列，当前目录项记录对应的数据页的页号，以及该页主键的最大值。
![](images/2022-06-21-17-08-00.png)


### 目录扩展
当记录的数据变多，可以通过在索引数据页中添加目录项记录的方式添加索引。
目录项记录太多，查找效率低，也可以通过为目录项建立目录（索引）的方式 优化查询
这样，索引结构就是一颗B+树。

![](images/2022-06-21-17-07-07.png)



## 索引的类型
### 聚簇索引
- 是一颗B+树
- 使用主键值作为数据的排序依据
- 叶子节点存放完整的数据记录。
### 二级索引
- 是一颗B+树
- 使用自定义的值作为数据的排序依据，如果相同，再按照主键排序。
- 叶子节点存放自定义的值和主键值
- 需要回表格
- 自定义的值可能不唯一，找到第一个后，只需要沿着页中的单链表遍历，直到不是要查找的值为止。


### 联合索引
- 是一颗B+树
- 使用定义的多个列作为数据的排序依据，比如C1，C3列，排序时，先按照C1排序，C1相同，再按照C3排序
- 叶子节点存放自定义的多个列的值和主键值

### 索引解决多页查询
查找的是主键列

索引将所有的页按照主键大小进行排序，然后为每一个页建立目录项记录，目录项记录里面存储的是页号以及页号指向的页的主键最小值。
在进行多页查找时，查找特定主键时，就可以通过二分查找目录项中主键的值，确定要查找的记录是在哪个页，再在具体的页中根据页的槽进行二分查找，将记录范围缩小到具体某个分组，在分组中再进行遍历查找。

查找的是普通列

如果建立了二级索引

比如时对name字段建立了二级索引，索引会把所有的列按照name去排序，然后为每一个页建立目录项记录，目录项记录里面存储的是主键、页号以及页号指向的页的name最小值。
在进行多表查询时，会先根据name二分查找到第一个匹配的记录，然后向后遍历，直到记录值不相同时，就得到了所有的叶子节点存储的记录，叶子节点会存储name字段和主键字段。然后就可以根据name字段对应的主键去数据库里面查找对应的记录，就可以返回了。

### 索引解决单页查询
实际上所有的索引查找记录时，都是用主键查找记录的，也就是槽。聚簇索引直接查找。二级索引先再自己的B+树上查找，再进行回标，再聚簇索引对应的二叉树上使用主键进行查找。



## 索引的注意事项
### 索引的根页面万年不挪窝
索引列的根页面初始化时是哪个就是哪个

问题

新建一个表时，MySQL会自动创建一个聚簇索引存放数据。
但由于记录是空的，只有根页面自己存放数据，那么当根页面满了以后，需要申请一个新的数据页存储记录。
又因为是聚簇索引，需要为多个页面建立页目录（根页面），那么这个新的根页面与原来的根页面是同一个嘛？

答

是同一个，为多个页面创建页目录时，会申请一个新的数据页，将原来的根页面的数据复制到这个新的数据页中，原来的数据页清空后，添加目录项，仍然是根页面

### 二级索引的目录项节点存放索引列、页面、主键，而不是索引列、页面
问题

如果二级目录项里面只存放索引列、页面号。
索引列存放的是对应页面号的最小值，但是如果该索引列重复的数据太多，导致两个页面的该字段都是相同的。
那么这两条目录项记录按照索引列、页面号方式存储就是完全相同的，无法区分，当我们插入一条记录时，又因为我们是通过二分查找搜索的页面，导致插入操作时，可能插入不同的页。

解决方案

存放索引列、页面、主键的方式，目录项就全部都是唯一的，不会出现无法区分的情况。



 
